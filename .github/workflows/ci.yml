name: CI

on:
  pull_request:
    paths:
      - "backend/**"

jobs:
  call-setup:
    uses: ./.github/workflows/setup.yml
    with:
      project-dir: "backend"
      python-version: "3.11"

  test:
    needs: call-setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - name: Run tests
        run: poetry run python -m pytest tests/

  lint:
    needs: call-setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Lint (flake8 + black)
        run: |
          poetry run flake8 .
          poetry run black --check .
